<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Archive Banner List</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet" crossorigin="anonymous">

    <style>
        :root {
            --asia-color: #d9534f;
            --global-color: #5bc0de;
            --global-pred-color: #f0ad4e;
        }

        [data-bs-theme="dark"] {
            --asia-color: #e57373;
            --global-color: #81d4fa;
            --global-pred-color: #ffd54f;
        }

        .asia {
            color: var(--asia-color);
        }

        .global {
            color: var(--global-color);
        }

        .predicted {
            color: var(--global-pred-color);
            font-style: italic;
        }

        .banner-img {
            max-height: 100px;
            max-width: 200px;
            object-fit: cover;
            border-radius: 4px;
        }

        @media (min-width: 768px) {
            .banner-img {
                max-height: 100%;
                max-width: 600px;
            }
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color .2s;
        }

        th.sortable:hover {
            background-color: var(--bs-table-hover-bg) !important;
        }
    </style>
</head>
<body class="py-4">
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
        <h1 class="h1 text-primary mb-0">Blue Archive Banner List ({{ total_banners }} total)</h1>
        <div class="d-flex gap-2">
            <button id="reset-sort-btn" class="btn btn-outline-secondary btn-sm">Reset Sort</button>
            {% if theme == 'dark' %}
                <a href="/set-theme/light" class="btn btn-outline-light btn-sm">Light Mode ‚òÄÔ∏è</a>
            {% else %}
                <a href="/set-theme/dark" class="btn btn-outline-dark btn-sm">Dark Mode üåô</a>
            {% endif %}
        </div>
    </div>

    <h2 class="h2 text-secondary mb-0">Global server banner prediction based on past Asia banners.</h2>
    <h2 class="h2 text-secondary mb-3">Score calculated from reviews on Reddit.</h2>

    <input type="text" id="search-input" class="form-control form-control-lg mb-3"
           value="{{ search_query or '' }}" placeholder="Search by unit, date, or 'rerun'...">

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle text-center">
            <thead>
            <tr class="sticky-top">
                <th data-sort-col="1">Banner</th>
                <th class="sortable" data-sort-col="2">Units</th>
                <th class="sortable" data-sort-col="3">Start Date</th>
                <th class="sortable" data-sort-col="4">End Date</th>
                <th class="sortable" id="score-header" data-sort-col="5">Community Score</th>
            </tr>
            </thead>
            <tbody id="banner-table-body">
            {% include 'partials/table_rows.html' %}
            </tbody>
        </table>
    </div>

    <footer class="text-center text-muted mt-4">
        <p>All banner data is sourced from <a href="https://bluearchive.wiki/" target="_blank">bluearchive.wiki</a>.</p>
        <p>This site is an independent fan project.</p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script>
    const searchInput = document.getElementById('search-input');
    const tableBody = document.getElementById('banner-table-body');

    function attachSentimentPlaceholders() {
        document.querySelectorAll('#banner-table-body tr').forEach(row => {
            if (row.cells.length === 4) {
                const cell = document.createElement('td');
                cell.className = 'text-center sentiment-cell-placeholder';
                cell.innerHTML = '<span class="text-muted small">Loading...</span>';
                row.appendChild(cell);
            }
        });
    }

    function updateTableSentiment() {
        const header = document.getElementById('score-header');
        document.querySelectorAll('.sentiment-cell-placeholder').forEach(cell => {
            cell.innerHTML = '<span class="text-muted small">N/A</span>';
        });

        fetch('/api/sentiment')
            .then(r => r.json())
            .then(payload => {
                const list = payload.data || [];
                const map = new Map(list.map(i => [i.units, {score: i.score, count: i.count}]));
                const running = payload.running;

                document.querySelectorAll('#banner-table-body tr').forEach(row => {
                    const unitNames = row.querySelector('.units-cell p').innerText.trim();
                    const cell = row.lastElementChild;
                    if (map.has(unitNames)) {
                        const {score, count} = map.get(unitNames);
                        const s = (parseFloat(score)+1)*50;
                        const cls = s > (1+0.3)*50 ? 'text-success' : s < (1-0.1)*50 ? 'text-danger' : 'text-warning';
                        cell.innerHTML = `<span class="fw-bold ${cls}">${s.toFixed(0)}</span>
                                          <small class="text-muted d-block">(${count} reviews)</small>`;
                        cell.classList.remove('sentiment-cell-placeholder');
                    } else {
                        cell.innerHTML = '<span class="text-muted small">Analyzing...</span>';
                    }
                });

                header.innerText = running ? 'Score (Updating...)' : 'Score';
                if (running) setTimeout(updateTableSentiment, 5000);
            })
            .catch(e => {
                console.error('Error loading sentiment:', e);
                document.getElementById('score-header').innerText = 'Score (Error)';
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        attachSentimentPlaceholders();
        updateTableSentiment();
    });

    searchInput.addEventListener('keyup', e => {
        clearTimeout(window._searchTimer);
        window._searchTimer = setTimeout(() => {
            fetch(`/search-api?search=${encodeURIComponent(searchInput.value)}`)
                .then(r => r.text())
                .then(html => {
                    tableBody.innerHTML = html;
                    attachSentimentPlaceholders();
                    updateTableSentiment();
                });
        }, 300);
    });

    document.querySelectorAll('th.sortable').forEach(th => {
        th.addEventListener('click', () => {
            const idx = parseInt(th.dataset.sortCol, 10) - 1;
            const dir = th.dataset.sortDir === 'asc' ? 'desc' : 'asc';
            th.dataset.sortDir = dir;
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            rows.sort((a, b) => {
                const ta = a.cells[idx].innerText.trim(), tb = b.cells[idx].innerText.trim();
                return ta.localeCompare(tb, undefined, {numeric: true}) * (dir === 'asc' ? 1 : -1);
            }).forEach(r => tableBody.appendChild(r));
        });
    });

    document.getElementById('reset-sort-btn').addEventListener('click', () => {
        searchInput.value = '';
        fetch('/search-api?search=')
            .then(r => r.text())
            .then(html => {
                tableBody.innerHTML = html;
                attachSentimentPlaceholders();
                updateTableSentiment();
            });
        document.querySelectorAll('th.sortable').forEach(th => th.dataset.sortDir = '');
    });
</script>
</body>
</html>
