<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ theme }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Archive Banner List</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <style>
        :root {
            --asia-color: #d9534f;
            --global-color: #5bc0de;
            --global-pred-color: #f0ad4e;
        }

        [data-bs-theme="dark"] {
            --asia-color: #e57373;
            --global-color: #81d4fa;
            --global-pred-color: #ffd54f;
        }

        .date-cell {
            white-space: nowrap;
        }

        .date-cell span {
            display: block;
        }

        .asia {
            color: var(--asia-color);
        }

        .global {
            color: var(--global-color);
        }

        .predicted {
            color: var(--global-pred-color);
            font-style: italic;
        }

        .banner-img {
            max-height: 100px;
            max-width: 200px;
            width: auto;
            object-fit: cover;
            border-radius: 4px;
        }

        th {
            white-space: nowrap;
        }

        .table {
            font-size: 0.95em;
        }

        .units-cell {
            text-align: left;
            vertical-align: middle;
            padding-left: 15px !important;
        }

        .banner-img {
            /* 1. –†–æ–∑–º—ñ—Ä –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º (–¥–ª—è –º–æ–±—ñ–ª—å–Ω–∏—Ö) */
            max-height: 100px;
            max-width: 200px;
            width: auto;
            object-fit: cover;
            border-radius: 4px;
        }

        @media (min-width: 768px) {
            .banner-img {
                max-height: 100%;
                max-width: 600px;
            }
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s;
        }

        th.sortable:hover {
            background-color: var(--bs-table-hover-bg) !important;
        }
    </style>
</head>
<body class="py-4">

<div class="container">

    <div class="d-flex justify-content-between align-items-center mb-3 pb-3 border-bottom">
        <h1 class="h1 text-primary mb-0">Blue Archive Banner List ({{ total_banners }} total)</h1>

        <div class="d-flex gap-2">
            <button id="reset-sort-btn" class="btn btn-outline-secondary btn-sm">Reset Sort</button>
            {% if theme == 'dark' %}
                <a href="/set-theme/light" class="btn btn-outline-light btn-sm">Light Mode ‚òÄÔ∏è</a>
            {% else %}
                <a href="/set-theme/dark" class="btn btn-outline-dark btn-sm">Dark Mode üåô</a>
            {% endif %}
        </div>

    </div>
    <h2>Global server banner prediction based on past Asia banners.</h2>

    <div class="mb-3">
        <input type="text" id="search-input" class="form-control form-control-lg"
               value="{{ search_query or '' }}"
               placeholder="Search by unit, date, or 'rerun'...">
    </div>

    <div class="table-responsive">
        <table class="table table-bordered table-striped table-hover align-middle text-center">
            <thead>
            <tr class="sticky-top">
                <th class="" data-sort-col="1">Banner</th>
                <th class="sortable" data-sort-col="2">Units</th>
                <th class="sortable" data-sort-col="3">Start Date</th>
                <th class="sortable" data-sort-col="4">End Date</th>
            </tr>
            </thead>
            <tbody id="banner-table-body">
            {% include 'partials/table_rows.html' %}
            </tbody>
        </table>
    </div>

    <footer class="text-center text-muted mt-4">
        <p>All banner data is sourced from
            <a href="https://bluearchive.wiki/" target="_blank">bluearchive.wiki</a>.
        </p>
        <p>This site is an independent fan project.</p>
    </footer>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    let timeout = null;
    const searchInput = document.getElementById('search-input');
    const tableBody = document.getElementById('banner-table-body');

    searchInput.addEventListener('keyup', function (e) {
        clearTimeout(timeout);
        timeout = setTimeout(function () {
            const query = searchInput.value;
            fetch(`/search-api?search=${encodeURIComponent(query)}`)
                .then(response => response.text())
                .then(html => {
                    tableBody.innerHTML = html;
                })
                .catch(error => console.error('Error fetching search results:', error));
        }, 300);
    });

    document.querySelectorAll('th.sortable').forEach(headerCell => {
        headerCell.addEventListener('click', () => {
            const table = headerCell.closest('table');
            const tbody = table.querySelector('tbody');
            const colIndex = parseInt(headerCell.dataset.sortCol, 10);
            const currentDir = headerCell.dataset.sortDir === 'asc' ? 'desc' : 'asc';
            headerCell.dataset.sortDir = currentDir;

            Array.from(tbody.querySelectorAll('tr'))
                .sort((rowA, rowB) => {
                    let cellA = rowA.querySelectorAll('td')[colIndex - 1].innerText;
                    let cellB = rowB.querySelectorAll('td')[colIndex - 1].innerText;

                    if (colIndex === 3 || colIndex === 4) {
                        cellA = cellA.split('\n')[0] || '';
                        cellB = cellB.split('\n')[0] || '';
                    }

                    return cellA.localeCompare(cellB, undefined, {numeric: true}) * (currentDir === 'asc' ? 1 : -1);
                })
                .forEach(sortedRow => {
                    tbody.appendChild(sortedRow);
                });
        });
    });

    document.getElementById('reset-sort-btn').addEventListener('click', () => {
        const query = searchInput.value;
        searchInput.value = '';
        fetch(`/search-api?search=`)
            .then(response => response.text())
            .then(html => {
                tableBody.innerHTML = html;
            })
            .catch(error => console.error('Error fetching search results:', error));

        document.querySelectorAll('th.sortable').forEach(headerCell => {
            headerCell.dataset.sortDir = '';
        });
    });
</script>
</body>
</html>